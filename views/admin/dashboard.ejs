<!DOCTYPE html>
<html lang="uz">
<head>
    <%- include('partials/head') %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Dashboard Specific Styles */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .dashboard-header h2 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .live-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Visitor Cards */
        .visitor-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .v-card {
            background: rgba(30, 27, 75, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 16px;
            border-top: 3px solid;
        }
        
        .v-card.c1 { border-top-color: #6366f1; }
        .v-card.c2 { border-top-color: #0ea5e9; }
        .v-card.c3 { border-top-color: #10b981; }
        .v-card.c4 { border-top-color: #f59e0b; }
        
        .v-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .v-value {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }
        
        .v-sub {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .chart-box {
            background: rgba(30, 27, 75, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 16px;
        }
        
        .chart-box h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-box h3 i {
            color: var(--primary);
        }
        
        .chart-area {
            height: 200px;
        }

        /* Mini Charts */
        .mini-charts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .mini-chart {
            background: rgba(30, 27, 75, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 14px;
        }
        
        .mini-chart h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .mini-area {
            height: 140px;
        }

        /* Top Pages */
        .pages-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .pages-list::-webkit-scrollbar {
            width: 3px;
        }
        
        .pages-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }
        
        .page-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            font-size: 12px;
        }
        
        .page-row:last-child {
            border-bottom: none;
        }
        
        .page-name {
            width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .page-bar {
            flex: 1;
            height: 4px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 2px;
            margin: 0 10px;
        }
        
        .page-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #0ea5e9);
            border-radius: 2px;
        }
        
        .page-count {
            width: 30px;
            text-align: right;
            font-weight: 600;
            color: var(--primary);
        }

        /* Bottom Section */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-box {
            background: rgba(30, 27, 75, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 16px;
        }
        
        .info-box h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .browser-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .browser-item {
            background: rgba(99, 102, 241, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .browser-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .quick-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .quick-btns .btn {
            padding: 8px 14px;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .visitor-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-section { grid-template-columns: 1fr; }
            .mini-charts { grid-template-columns: repeat(2, 1fr); }
            .bottom-section { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .visitor-grid { grid-template-columns: 1fr 1fr; }
            .mini-charts { grid-template-columns: 1fr; }
            .dashboard-header { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
        
        @media (max-width: 500px) {
            .visitor-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <%- include('partials/sidebar') %>
        <main class="main-content">
            <%- include('partials/topbar') %>
            <div class="page-content">
                
                <!-- Header -->
                <div class="dashboard-header">
                    <h2><i class="fas fa-chart-line"></i> Statistika</h2>
                    <div class="live-badge">
                        <span class="live-dot"></span>
                        <span><%= visitorStats.realtime %> faol</span>
                    </div>
                </div>

                <!-- Visitor Stats -->
                <div class="visitor-grid">
                    <div class="v-card c1">
                        <div class="v-label">Bugungi</div>
                        <div class="v-value"><%= visitorStats.today %></div>
                        <div class="v-sub"><%= visitorStats.uniqueToday %> noyob</div>
                    </div>
                    <div class="v-card c2">
                        <div class="v-label">Haftalik</div>
                        <div class="v-value"><%= visitorStats.weekly %></div>
                        <div class="v-sub"><%= visitorStats.uniqueWeekly %> noyob</div>
                    </div>
                    <div class="v-card c3">
                        <div class="v-label">Oylik</div>
                        <div class="v-value"><%= visitorStats.monthly %></div>
                        <div class="v-sub"><%= visitorStats.uniqueMonthly %> noyob</div>
                    </div>
                    <div class="v-card c4">
                        <div class="v-label">Ko'rishlar</div>
                        <div class="v-value"><%= stats.totalViews %></div>
                        <div class="v-sub">Jami bloglar</div>
                    </div>
                </div>

                <!-- Main Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blogs"><i class="fas fa-newspaper"></i></div>
                        <div class="stat-info"><h3><%= stats.blogCount %></h3><p>Bloglar</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon categories"><i class="fas fa-folder"></i></div>
                        <div class="stat-info"><h3><%= stats.categoryCount %></h3><p>Kategoriyalar</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon comments"><i class="fas fa-comments"></i></div>
                        <div class="stat-info"><h3><%= stats.commentCount %></h3><p>Izohlar</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon pending"><i class="fas fa-clock"></i></div>
                        <div class="stat-info"><h3><%= stats.pendingComments %></h3><p>Kutmoqda</p></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-section">
                    <div class="chart-box">
                        <h3><i class="fas fa-chart-area"></i> 30 kunlik tashriflar</h3>
                        <div class="chart-area"><canvas id="mainChart"></canvas></div>
                    </div>
                    <div class="chart-box">
                        <h3><i class="fas fa-star"></i> Top sahifalar</h3>
                        <div class="pages-list">
                            <% const max = chartData.topPages[0]?.count || 1; %>
                            <% chartData.topPages.slice(0,8).forEach(p => { %>
                            <div class="page-row">
                                <span class="page-name" title="<%= p._id %>"><%= p._id === '/' ? 'Bosh sahifa' : p._id %></span>
                                <div class="page-bar"><div class="page-bar-fill" style="width:<%= (p.count/max*100) %>%"></div></div>
                                <span class="page-count"><%= p.count %></span>
                            </div>
                            <% }); %>
                            <% if(!chartData.topPages.length) { %><p style="color:#64748b;text-align:center;padding:20px">Ma'lumot yo'q</p><% } %>
                        </div>
                    </div>
                </div>

                <!-- Mini Charts -->
                <div class="mini-charts">
                    <div class="mini-chart">
                        <h4><i class="fas fa-clock" style="color:#0ea5e9"></i> Soatlik</h4>
                        <div class="mini-area"><canvas id="hourlyChart"></canvas></div>
                    </div>
                    <div class="mini-chart">
                        <h4><i class="fas fa-calendar" style="color:#10b981"></i> Hafta kunlari</h4>
                        <div class="mini-area"><canvas id="weekChart"></canvas></div>
                    </div>
                    <div class="mini-chart">
                        <h4><i class="fas fa-mobile-alt" style="color:#f59e0b"></i> Qurilmalar</h4>
                        <div class="mini-area"><canvas id="deviceChart"></canvas></div>
                    </div>
                </div>

                <!-- Bottom -->
                <div class="bottom-section">
                    <div class="info-box">
                        <h4><i class="fab fa-chrome" style="color:var(--primary)"></i> Brauzerlar</h4>
                        <div class="browser-list">
                            <% const colors = {Chrome:'#4285F4',Firefox:'#FF7139',Safari:'#000',Edge:'#0078D7',Opera:'#FF1B2D'}; %>
                            <% chartData.browsers.forEach(b => { %>
                            <div class="browser-item">
                                <span class="browser-dot" style="background:<%= colors[b._id] || '#64748b' %>"></span>
                                <%= b._id || 'Boshqa' %> <strong><%= b.count %></strong>
                            </div>
                            <% }); %>
                            <% if(!chartData.browsers.length) { %><span style="color:#64748b">Ma'lumot yo'q</span><% } %>
                        </div>
                    </div>
                    <div class="info-box">
                        <h4>Tezkor harakatlar</h4>
                        <div class="quick-btns">
                            <a href="/admin/blogs/create" class="btn btn-primary"><i class="fas fa-plus"></i> Blog</a>
                            <a href="/admin/categories/create" class="btn btn-secondary"><i class="fas fa-folder-plus"></i> Kategoriya</a>
                            <a href="/admin/comments?status=pending" class="btn btn-warning"><i class="fas fa-eye"></i> Izohlar</a>
                        </div>
                    </div>
                </div>

                <!-- Recent Blogs -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">So'nggi bloglar</h3>
                        <a href="/admin/blogs" class="btn btn-sm btn-secondary">Barchasi</a>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Sarlavha</th><th>Kategoriya</th><th>Ko'rish</th><th>Holat</th><th>Sana</th><th></th></tr></thead>
                            <tbody>
                            <% recentBlogs.forEach(b => { %>
                            <tr>
                                <td><strong><%= b.title.substring(0,30) %><%= b.title.length>30?'...':'' %></strong></td>
                                <td><%= b.category?.name || '-' %></td>
                                <td style="color:var(--primary);font-weight:600"><%= b.views || 0 %></td>
                                <td><span class="badge <%= b.status==='published'?'badge-success':b.status==='draft'?'badge-warning':'badge-danger' %>"><%= b.status==='published'?'Nashr':b.status==='draft'?'Qoralama':'Arxiv' %></span></td>
                                <td><%= new Date(b.createdAt).toLocaleDateString('uz') %></td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/admin/blogs/<%= b._id %>/edit" class="action-btn edit"><i class="fas fa-edit"></i></a>
                                        <a href="/blog/<%= b.slug %>" target="_blank" class="action-btn view"><i class="fas fa-eye"></i></a>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                            <% if(!recentBlogs.length) { %><tr><td colspan="6" style="text-align:center;color:#64748b">Blog yo'q</td></tr><% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = 'Outfit';
        
        // Main Chart
        const ctx1 = document.getElementById('mainChart').getContext('2d');
        const grad = ctx1.createLinearGradient(0,0,0,200);
        grad.addColorStop(0,'rgba(99,102,241,0.3)');
        grad.addColorStop(1,'rgba(99,102,241,0)');
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: <%- JSON.stringify(chartData.daily.labels) %>,
                datasets: [{
                    data: <%- JSON.stringify(chartData.daily.views) %>,
                    borderColor: '#6366f1',
                    backgroundColor: grad,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: { size: 10 } } },
                    y: { beginAtZero: true, grid: { color: 'rgba(99,102,241,0.1)' }, ticks: { font: { size: 10 } } }
                }
            }
        });
        
        // Hourly
        new Chart(document.getElementById('hourlyChart'), {
            type: 'bar',
            data: {
                labels: <%- JSON.stringify(chartData.hourly.labels) %>,
                datasets: [{ data: <%- JSON.stringify(chartData.hourly.data) %>, backgroundColor: 'rgba(14,165,233,0.6)', borderRadius: 2 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { maxTicksLimit: 6, font: { size: 9 } } }, y: { beginAtZero: true, grid: { color: 'rgba(99,102,241,0.1)' }, ticks: { font: { size: 9 } } } } }
        });
        
        // Week
        new Chart(document.getElementById('weekChart'), {
            type: 'polarArea',
            data: {
                labels: <%- JSON.stringify(chartData.weekday.labels) %>,
                datasets: [{ data: <%- JSON.stringify(chartData.weekday.data) %>, backgroundColor: ['#ef4444aa','#6366f1aa','#0ea5e9aa','#10b981aa','#f59e0baa','#ec4899aa','#a855f7aa'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { ticks: { display: false }, grid: { color: 'rgba(99,102,241,0.1)' } } } }
        });
        
        // Device
        const dd = <%- JSON.stringify(chartData.devices) %>;
        new Chart(document.getElementById('deviceChart'), {
            type: 'doughnut',
            data: {
                labels: dd.map(d => ({desktop:'Kompyuter',mobile:'Telefon',tablet:'Planshet',unknown:'Boshqa'}[d._id]||d._id)),
                datasets: [{ data: dd.map(d => d.count), backgroundColor: ['#6366f1cc','#0ea5e9cc','#10b981cc','#64748bcc'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '55%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 8, font: { size: 9 } } } } }
        });
    </script>
</body>
</html>
